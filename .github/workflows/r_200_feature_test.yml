name: R_200 - Docker Setup Wizard

permissions:
  contents: read

# This workflow tests the initial setup wizard in a Docker environment
# It verifies that a user can complete the full setup process in a fresh Docker deployment

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  docker-setup-wizard-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      # Build and start Docker containers with docker-compose
      - name: Build and start Docker containers
        uses: hoverkraft-tech/compose-action@v2.4.1
        with:
          compose-file: "./docker-compose.yml"
          up-flags: "--build --wait"
      
      # Wait for services to start up (database and application initialization)
      - name: Wait for Trustpoint to be ready
        run: |
          echo "Waiting for Trustpoint to be ready..."
          echo "Initial startup delay for database initialization..."
          sleep 30
          
          echo "Checking container status..."
          docker compose ps
          
          echo "Waiting for HTTP response..."
          for i in {1..40}; do
            http_code=$(curl -k -s -o /dev/null -w "%{http_code}" https://127.0.0.1/ || echo "000")
            
            if [ "$http_code" = "200" ] || [ "$http_code" = "302" ]; then
              echo "✓ Trustpoint is ready (HTTP $http_code)"
              docker compose logs trustpoint | tail -20
              break
            fi
            
            echo "Waiting... (attempt $i/40, HTTP code: $http_code)"
            
            if [ $i -eq 40 ]; then
              echo "ERROR: Trustpoint did not become ready in time"
              echo "=== Container Status ==="
              docker compose ps
              echo "=== Trustpoint Logs ==="
              docker compose logs trustpoint
              echo "=== PostgreSQL Logs ==="
              docker compose logs postgres
              exit 1
            fi
            
            sleep 5
          done
      
      # Verify the setup wizard is accessible
      - name: Test Setup Wizard Accessibility
        run: |
          echo "Testing setup wizard accessibility..."
          
          # First, try accessing the root path which should redirect to setup wizard
          echo "Checking root path (should redirect to setup wizard)..."
          http_code=$(curl -k -s -L -o /tmp/root-page.html -w "%{http_code}" https://127.0.0.1/ || echo "000")
          echo "Root path returned: HTTP $http_code"
          
          # Check if we're on setup wizard (either at root or after redirect)
          if grep -q -i "setup\|wizard\|crypto.*storage\|storage.*crypto" /tmp/root-page.html; then
            echo "✓ Setup wizard is accessible from root path"
            WIZARD_FOUND=true
          else
            echo "Root path did not show setup wizard, trying direct setup-wizard URL..."
            
            # Try direct access to setup-wizard path
            http_code=$(curl -k -s -L -o /tmp/setup-wizard.html -w "%{http_code}" https://127.0.0.1/setup-wizard/ || echo "000")
            echo "Setup wizard path returned: HTTP $http_code"
            
            if [ "$http_code" = "200" ] && grep -q -i "setup\|wizard\|crypto\|storage" /tmp/setup-wizard.html; then
              echo "✓ Setup wizard is accessible at /setup-wizard/"
              WIZARD_FOUND=true
            else
              echo "✗ Setup wizard not found"
              echo "Root page content:"
              cat /tmp/root-page.html | head -50
              echo ""
              echo "Setup wizard page content:"
              cat /tmp/setup-wizard.html | head -50
              WIZARD_FOUND=false
            fi
          fi
          
          if [ "$WIZARD_FOUND" = "true" ]; then
            echo ""
            echo "✓ Docker Setup Wizard test PASSED"
            echo "  - Container started successfully"
            echo "  - Database initialized"
            echo "  - Setup wizard is accessible"
            echo "  - Ready for first-time user configuration"
          else
            exit 1
          fi
      
      # Upload the setup wizard HTML page as an artifact for inspection
      - name: Upload Setup Wizard Page
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: setup-wizard-page
          path: /tmp/setup-wizard.html
      
      # Display container logs for debugging
      - name: Show container logs
        if: always()
        run: |
          echo "=== Trustpoint Container Logs (last 100 lines) ==="
          docker compose logs --tail=100 trustpoint
          echo ""
          echo "=== PostgreSQL Container Logs (last 50 lines) ==="
          docker compose logs --tail=50 postgres
      
      # Cleanup: Stop and remove containers
      - name: Cleanup containers
        if: always()
        run: docker compose down -v
