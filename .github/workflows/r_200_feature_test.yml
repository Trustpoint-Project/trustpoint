name: R_200 - Docker Setup Wizard

# This workflow tests the initial setup wizard in a Docker environment
# It verifies that a user can complete the full setup process in a fresh Docker deployment

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  docker-setup-wizard-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      # Build and start Docker containers with docker-compose
      - name: Build and start Docker containers
        uses: hoverkraft-tech/compose-action@v2.4.1
        with:
          compose-file: "./docker-compose.yml"
          up-flags: "--build --wait"
      
      # Check container status
      - name: Check container status
        run: |
          echo "=== Checking container status ==="
          docker compose ps
          echo "=== Checking Trustpoint container logs ==="
          docker compose logs trustpoint | tail -50
      
      # Wait for the application to be fully ready with better health check
      - name: Wait for Trustpoint to be ready
        run: |
          echo "Waiting for Trustpoint to be ready..."
          
          # Check if container is running
          if ! docker compose ps | grep -q "trustpoint.*running"; then
            echo "ERROR: Trustpoint container is not running!"
            docker compose logs trustpoint
            exit 1
          fi
          
          # Wait for HTTP response
          for i in {1..60}; do
            http_code=$(curl -k -s -o /dev/null -w "%{http_code}" https://127.0.0.1/ || echo "000")
            if [ "$http_code" = "200" ] || [ "$http_code" = "302" ]; then
              echo "âœ“ Trustpoint is ready (HTTP $http_code)"
              break
            fi
            echo "Waiting... (attempt $i/60, HTTP $http_code)"
            
            if [ $i -eq 60 ]; then
              echo "ERROR: Trustpoint did not become ready in time"
              docker compose logs trustpoint
              exit 1
            fi
            sleep 3
          done
      
      # Install dev dependencies in the container
      - name: Install dev dependencies
        run: |
          docker compose exec -T trustpoint bash -c "cd /var/www/html/trustpoint && uv sync --group dev"
      
      # Execute the setup wizard feature test inside the container
      - name: Run Setup Wizard Feature Test
        run: |
          docker compose exec -T trustpoint bash -c "\
            cd /var/www/html/trustpoint/trustpoint && \
            DJANGO_SETTINGS_MODULE=trustpoint.settings /var/www/html/trustpoint/.venv/bin/python -m behave \
            --format html \
            --outfile /tmp/behave-report.html \
            features/R_200_docker_setup_wizard.feature"
      
      # Copy the test report from container to host
      - name: Copy test report from container
        if: always()
        run: |
          docker compose cp trustpoint:/tmp/behave-report.html ./behave-report.html || \
          echo "Warning: Could not copy test report"
      
      # Upload the HTML test report as an artifact
      - name: Upload Test Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: r_200-docker-setup-wizard-html-report
          path: behave-report.html
      
      # Display container logs for debugging
      - name: Show container logs
        if: always()
        run: |
          echo "=== Trustpoint Container Logs (last 100 lines) ==="
          docker compose logs --tail=100 trustpoint
          echo ""
          echo "=== PostgreSQL Container Logs (last 50 lines) ==="
          docker compose logs --tail=50 postgres
      
      # Cleanup: Stop and remove containers
      - name: Cleanup containers
        if: always()
        run: docker compose down -v
