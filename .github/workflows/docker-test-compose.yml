name: Docker Compose Test

on: [pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Docker compose
      uses: hoverkraft-tech/compose-action@v2.2.0
      with:
        compose-file: "./docker-compose.yml"
        up-flags: "--build --wait"

    - name: Test Home Page with curl
      run: |
        for i in {1..10}; do
        http_response=$(curl -s -o response.txt -w "%{response_code}" http://127.0.0.1:80 || true)
        if [ "$http_response" == "200" ]; then
          echo "Success on attempt $i"
          break
        else
          echo "Attempt $i failed with code $http_response, retrying..."
          sleep 3
        fi
        done
        
        echo "Server returned: $http_response" >> $GITHUB_STEP_SUMMARY
        if [ $http_response != "200" ]; then
          echo "This is not expected! Failing Pipeline!" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "This expected, the full response is:" >> $GITHUB_STEP_SUMMARY
          cat response.txt >> $GITHUB_STEP_SUMMARY
        fi
