name: ZAP Baseline Scan

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  zap-baseline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Start Trustpoint via docker-compose
        run: |
          docker compose -f docker-compose.yml up -d
          # give the app time to start
          sleep 60

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        continue-on-error: true
        id: zap-scan
        with:
          target: "http://localhost:80"
          fail_action: false
          cmd_options: "-a"
          allow_issue_writing: false 
          create_issue: false
          artifact_name: "" 

      - name: Upload ZAP Scan Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-reports
          path: |
            report_json.json
            report_md.md
            report_html.html
          retention-days: 30

      - name: Check ZAP Scan Results
        if: always()
        run: |
          if [ -f report_json.json ]; then
            # Count WARN and FAIL alerts
            WARN_COUNT=$(grep -o "WARN-NEW" report_md.md | wc -l || echo "0")
            FAIL_COUNT=$(grep -o "FAIL-NEW" report_md.md | wc -l || echo "0")
            
            echo "ZAP Scan Results:"
            echo "  Warnings: $WARN_COUNT"
            echo "  Failures: $FAIL_COUNT"
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "::error::ZAP found $FAIL_COUNT high/medium severity issues"
              exit 1
            elif [ "$WARN_COUNT" -gt 0 ]; then
              echo "::warning::ZAP found $WARN_COUNT warnings (low severity)"
            fi
          fi

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.yml down
