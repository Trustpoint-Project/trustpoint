{% extends 'trustpoint/base.html' %}
{% load i18n %}
{% load crispy_forms_filters %}

{% block content %}
    <form method="POST">
        {% csrf_token %}
        <div class="card">
            <div class="card-header">
                <div>
                    <h1>{% trans 'Sign Hash Value' %}</h1>
                </div>
            </div>
            <div class="card-body">
                <p class="mb-4">
                    {% trans 'Use this form to sign a hash value with a selected signer. The hash must be provided in hexadecimal format.' %}
                </p>

                <div class="mb-3">
                    {{ form.signer|as_crispy_field }}
                </div>

                <div class="mb-3" id="hash-algorithm-info" style="display: none;">
                    <div class="alert alert-info">
                        <strong>{% trans 'Hash Algorithm:' %}</strong> 
                        <span id="hash-algorithm-name"></span>
                        <br>
                        <small>{% trans 'This algorithm is determined by the selected signer\'s certificate.' %}</small>
                    </div>
                </div>

                <div class="mb-3">
                    {{ form.hash_value|as_crispy_field }}
                </div>

                <div class="alert alert-info" role="alert">
                    <strong>{% trans 'Note:' %}</strong>
                    {% trans 'The hash value must be in hexadecimal format without any prefix (e.g., no "0x"). Ensure the hash length matches the signer\'s algorithm.' %}
                </div>
            </div>
            <div class="card-footer d-flex">
                <div class="tp-card-btn-footer m-1">
                    <a href="{% url 'signer:signer_list' %}" class="btn btn-secondary">{% trans 'Cancel' %}</a>
                </div>
                <div class="tp-card-btn-footer m-1">
                    <button type="submit" class="btn btn-primary">{% trans 'Sign Hash' %}</button>
                </div>
            </div>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const signerSelect = document.getElementById('id_signer');
            const hashAlgorithmInfo = document.getElementById('hash-algorithm-info');
            const hashAlgorithmName = document.getElementById('hash-algorithm-name');

            // Signer data with hash algorithms
            const signerData = {
                {% for signer in form.signer.field.queryset %}
                    '{{ signer.pk }}': '{{ signer.hash_algorithm }}',
                {% endfor %}
            };

            function updateHashAlgorithm() {
                const selectedSignerId = signerSelect.value;
                if (selectedSignerId && signerData[selectedSignerId]) {
                    const algorithm = signerData[selectedSignerId];
                    hashAlgorithmName.textContent = algorithm;
                    hashAlgorithmInfo.style.display = 'block';
                } else {
                    hashAlgorithmInfo.style.display = 'none';
                }
            }

            signerSelect.addEventListener('change', updateHashAlgorithm);
            updateHashAlgorithm(); // Initialize on page load
        });
    </script>
{% endblock content %}
