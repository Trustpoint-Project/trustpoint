{% extends is_browser_dl|yesno:"users/base.html,trustpoint/base.html" %}
{% load i18n %}
{% load crispy_forms_filters %}

{% block content %}

<form method="POST" autocomplete="off">
    {% csrf_token %}

    <div class="card">
        <div class="card-header">
            <div class="">
                <h1>{{ credential_type }} {% trans 'Download' %}</h1>
            </div>
        </div>
        <div class="card-body">
            <div class="tp-card-centered-content">
                <h2>{{ credential_type }} {% trans 'Details' %}</h2>
                <hr>
                <div class="tp-kvp-list">
                    <div>
                        <div>{% trans 'Device' %}</div>
                        <div>{{ issued_credential.device.common_name }}</div>
                    </div>
                    <div>
                        <div>{% trans 'Domain' %}</div>
                        <div>{{ issued_credential.domain.unique_name }}</div>
                    </div>
                    <div>
                        <div>{% trans 'Issuing CA' %}</div>
                        <div>{{ issued_credential.domain.issuing_ca.unique_name }}</div>
                    </div>
                </div>
                <hr>
                <h2>Certificate Subject</h2>
                <hr>
                <div class="tp-kvp-list">
                    <div>
                        <div>{% trans 'Common Name' %}</div>
                        <div>{{ issued_credential.common_name }}</div>
                    </div>
                    {% if pseudonym %}
                    <div>
                        <div>{% trans 'Pseudonym' %}</div>
                        <div>{{ pseudonym }}</div>
                    </div>
                    {% endif %}
                    <div>
                        <div>{% trans 'Domain Component' %}</div>
                        <div>{{ domain_component }}</div>
                    </div>
                    <div>
                        <div>{% trans 'Serial Number' %}</div>
                        <div>{{ serial_number }}</div>
                    </div>
                </div>
                <hr class="mb-5">
                <h2>{{ credential_type }} {% trans 'Download' %}</h2>
                <hr>

                <!-- Display form errors if any -->
                {% if form.errors %}
                    <div class="alert alert-danger" role="alert">
                        <strong>{% trans "Error:" %}</strong>
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="alert alert-info" role="alert">
                    <h5 class="alert-heading">{% trans "Suggested Password" %}</h5>
                    <div class="input-group mb-2">
                        <input type="text" id="id_password" name="password" class="form-control {% if form.password.errors %}is-invalid{% endif %}"
                               value="{% if form.password.value %}{{ form.password.value }}{% else %}{{ suggested_password }}{% endif %}">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-outline-primary" id="copy-btn">
                                {% trans "Copy" %}
                            </button>
                        </div>
                    </div>
                    <small>{% trans "You can use the suggested password above, or edit it as you wish. Must be at least 8 characters long." %}</small>
                </div>

                <div class="alert alert-warning d-none mb-3" id="copy-warning" role="alert">
                    <strong>{% trans "Important:" %}</strong> {% trans "Make sure you keep the password with you, it will be lost once you leave this screen" %}
                </div>

                <hr>
                <button type="submit" class="btn btn-primary min-width-42 mb-3" name="file_format"
                        value="{{ FileFormat.PKCS12.value }}">{% trans 'Download as PKCS#12' %}
                </button>
                <br>
                <button type="submit" class="btn btn-primary min-width-42 mb-3" name="file_format"
                        value="{{ FileFormat.PEM_ZIP.value }}">{% trans 'Download as ZIP (PEM)' %}
                </button>
                <br>
                <button type="submit" class="btn btn-primary min-width-42" name="file_format"
                        value="{{ FileFormat.PEM_TAR_GZ.value }}">{% trans 'Download as TAR.GZ (PEM)' %}
                </button>

                {% if not is_browser_dl %}
                <hr>
                <a href="{% url browser_otp_url pk=issued_credential.id %}" class="btn btn-primary min-width-42">{% trans 'Download on Device browser' %}</a>
                {% endif %}
            </div>
        </div>
        {% if not is_browser_dl %}
        <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="tp-card-btn-footer m-1">
                <a href="{% url clm_url pk=issued_credential.device.id %}" class="btn btn-secondary">{% trans 'Back'%}</a>
                <a href="{% url 'devices:devices' %}" class="btn btn-secondary">{% trans 'Cancel' %}</a>
            </div>
        </div>
        {% endif %}
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var copyBtn = document.getElementById('copy-btn');
        var passwordInput = document.getElementById('id_password');
        var copyWarning = document.getElementById('copy-warning');

        if (copyBtn && passwordInput && copyWarning) {
            copyBtn.addEventListener('click', function() {
                passwordInput.select();
                passwordInput.setSelectionRange(0, 99999);

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(passwordInput.value).then(function() {
                        showWarning();
                    });
                } else {
                    document.execCommand('copy');
                    showWarning();
                }
            });

            function showWarning() {
                copyWarning.classList.remove('d-none');
                setTimeout(function() {
                    copyWarning.classList.add('d-none');
                }, 10000);
            }
        }
    });
</script>

{% endblock %}
