{% extends "trustpoint/base.html" %}
{% load i18n static %}

{% block content %}

    {# ────────────────────────────────────────────── #}
    {#       Local Backup Management Table    #}
    {# ────────────────────────────────────────────── #}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 class="m-0">{% trans "Local Backup management" %}</h1>
            <form method="post" class="m-0 d-flex gap-2">
                {% csrf_token %}
                <button type="submit" name="create_local_backup" class="btn btn-primary">
                    {% trans "Create Local Backup" %}
                </button>
            </form>
        </div>

        <form id="batch-form" method="post" action="">
            {% csrf_token %}
            <div class="card-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"/></th>
                        <th>
                            <a href="?sort={% if current_sort == 'filename' %}-{% endif %}filename">
                                {% trans "File name" %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort={% if current_sort == 'created_at' %}-{% endif %}created_at">
                                {% trans "Created at" %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort={% if current_sort == 'modified_at' %}-{% endif %}modified_at">
                                {% trans "Last modified" %}
                            </a>
                        </th>
                        <th class="text-end">
                            <a href="?sort={% if current_sort == 'size_kb' %}-{% endif %}size_kb">
                                {% trans "Size (KB)" %}
                            </a>
                        </th>
                        <th>{% trans "Download" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for backup in backup_files %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected" value="{{ backup.filename }}"
                                       class="row-checkbox"/>
                            </td>
                            <td>{{ backup.filename }}</td>
                            <td>{{ backup.created_at }}</td>
                            <td>{{ backup.modified_at }}</td>
                            <td class="text-end">{{ backup.size_kb }}</td>
                            <td>
                                <a href="{% url 'management:backup-download' filename=backup.filename %}"
                                   class="btn btn-sm btn-outline-primary">
                                    {% trans "Download" %}
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">
                                {% trans "No backups found." %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% include "trustpoint/pagination.html" %}
            </div>

            <div class="card-footer d-flex justify-content-between">
                <div class="tp-card-btn-footer m-1">
                    <button formaction="{% url 'management:backup-download-multiple' archive_format='tar.gz' %}"
                            formmethod="post"
                            class="btn btn-secondary">
                        {% trans "Download (tar.gz)" %}
                    </button>
                    <button formaction="{% url 'management:backup-download-multiple' archive_format='zip' %}"
                            formmethod="post"
                            class="btn btn-secondary">
                        {% trans "Download (zip)" %}
                    </button>
                </div>
                <div class="m-1">
                    <button formaction="{% url 'management:backup-delete-multiple' %}"
                            formmethod="post"
                            class="btn btn-danger">
                        {% trans "Delete" %}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <hr>

    {# ────────────────────────────────────────────── #}
    {#       SFTP Backup Settings Form         #}
    {# ────────────────────────────────────────────── #}
    <div class="card mb-4">
        <div class="card-header">
            <h2 class="h5 mb-0">{% trans "SFTP Backup" %}</h2>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {{ backup_options_form.non_field_errors }}

                <div class="form-check form-switch mb-3">
                    {{ backup_options_form.enable_sftp_storage }}
                    {{ backup_options_form.enable_sftp_storage.label_tag }}
                    {{ backup_options_form.enable_sftp_storage.errors }}
                </div>

                <div id="dependent-options" style="{% if not backup_options_form.initial.enable_sftp_storage %}display: none;{% endif %}">
                    <div class="alert alert-info" role="alert">
                        {% trans "Note: Backups will be stored remotely via the SFTP protocol." %}
                    </div>

                    <div class="mb-3">
                        {{ backup_options_form.host.label_tag }}
                        {{ backup_options_form.host }}
                        {{ backup_options_form.host.errors }}
                    </div>

                    <div class="mb-3">
                        {{ backup_options_form.port.label_tag }}
                        {{ backup_options_form.port }}
                        {{ backup_options_form.port.errors }}
                    </div>

                    <div class="mb-3">
                        {{ backup_options_form.user.label_tag }}
                        {{ backup_options_form.user }}
                        {{ backup_options_form.user.errors }}
                    </div>

                    <div class="mb-3">
                        {{ backup_options_form.auth_method.label_tag }}
                        {{ backup_options_form.auth_method }}
                        {{ backup_options_form.auth_method.errors }}
                    </div>

                    <div class="mb-3 password-fields"
                        style="{% if backup_options_form.initial.auth_method != 'password' %}display:none;{% endif %}">
                        {{ backup_options_form.password.label_tag }}
                        {{ backup_options_form.password }}
                        {{ backup_options_form.password.errors }}
                    </div>

                    <div class="mb-3 ssh-key-fields"
                        style="{% if backup_options_form.initial.auth_method != 'ssh_key' %}display:none;{% endif %}">
                        {{ backup_options_form.private_key.label_tag }}
                        {{ backup_options_form.private_key }}
                        {{ backup_options_form.private_key.errors }}
                    </div>

                    <div class="mb-3 ssh-key-fields"
                        style="{% if backup_options_form.initial.auth_method != 'ssh_key' %}display:none;{% endif %}">
                        {{ backup_options_form.key_passphrase.label_tag }}
                        {{ backup_options_form.key_passphrase }}
                        {{ backup_options_form.key_passphrase.errors }}
                    </div>

                    <div class="mb-3">
                        {{ backup_options_form.remote_directory.label_tag }}
                        {{ backup_options_form.remote_directory }}
                        {{ backup_options_form.remote_directory.errors }}
                        <small class="form-text text-muted">
                            {% trans "Remote directory on SFTP server (e.g. /backups/). Required if using SFTP." %}
                        </small>
                    </div>

                    <hr>

                    <div id="sftp-action-buttons" style="{% if not has_saved_settings %}display: none;{% endif %}">
                        <button type="submit" name="test_sftp_connection" class="btn btn-outline-primary me-2">
                            {% trans "Test Connection" %}
                        </button>
                        <button type="submit" name="create_sftp_backup" class="btn btn-primary">
                            {% trans "Create SFTP Backup" %}
                        </button>
                    </div>

                    <hr>
                </div>

                <div class="d-flex">
                    <button type="submit" name="save_backup_settings" class="btn btn-success me-2">
                        {% trans "Save Settings" %}
                    </button>
                    <button type="submit" name="reset_backup_settings" class="btn btn-danger" {% if not has_saved_settings %}disabled{% endif %}>
                        {% trans "Reset Settings" %}
                    </button>
                </div>
            </form>
            {% if backup_options_form.errors %}
                <div class="alert alert-danger mt-3">
                    {% for field, errors in backup_options_form.errors.items %}
                        {% for error in errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // “Select All” checkbox behavior:
        document.getElementById('select-all').addEventListener('change', function (e) {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = e.target.checked);
        });

        // Toggle password vs. SSH‐key fields:
        document.addEventListener('DOMContentLoaded', function () {
            const select = document.querySelector('select[name="auth_method"]');

            function toggleFields() {
                const val = select.value;
                document.querySelectorAll('.password-fields')
                    .forEach(el => el.style.display = (val === 'password' ? 'block' : 'none'));
                document.querySelectorAll('.ssh-key-fields')
                    .forEach(el => el.style.display = (val === 'ssh_key' ? 'block' : 'none'));
            }

            select.addEventListener('change', toggleFields);
            toggleFields();
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sftpStorageCheckbox = document.querySelector('input[name="enable_sftp_storage"]');
            const dependentOptions = document.getElementById('dependent-options');

            function toggleVisibilityBasedOnSftpStorage() {
                if (sftpStorageCheckbox && sftpStorageCheckbox.checked) {
                    dependentOptions.style.display = 'block';
                } else {
                    dependentOptions.style.display = 'none';
                }
            }

            if (sftpStorageCheckbox) {
                sftpStorageCheckbox.addEventListener('change', toggleVisibilityBasedOnSftpStorage);
                toggleVisibilityBasedOnSftpStorage();
            }
        });
    </script>

{% endblock %}