# Generated by Django 6.0.2 on 2026-02-13 08:18

import django.db.models.deletion
import trustpoint.logger
import util.encrypted_fields
import util.field
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('onboarding', '0002_tp_v0_5_0_dev1'),
        ('pki', '0002_tp_v0_4_0'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='issuingcamodel',
            name='credential',
        ),
        migrations.AddField(
            model_name='certificatemodel',
            name='issuer_id',
            field=models.ForeignKey(blank=True, db_column='issuer_id', null=True, on_delete=django.db.models.deletion.SET_NULL, to='pki.certificatemodel', verbose_name='Issuer Certificate'),
        ),
        migrations.AlterField(
            model_name='credentialmodel',
            name='certificate',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='credential_set', to='pki.certificatemodel'),
        ),
        migrations.AlterField(
            model_name='credentialmodel',
            name='certificates',
            field=models.ManyToManyField(blank=True, related_name='credential', through='pki.PrimaryCredentialCertificate', to='pki.certificatemodel'),
        ),
        migrations.AlterField(
            model_name='credentialmodel',
            name='private_key',
            field=util.encrypted_fields.EncryptedCharField(blank=True, default='', max_length=116633, verbose_name='Private key (PEM)'),
        ),
        migrations.AlterField(
            model_name='truststoremodel',
            name='intended_usage',
            field=models.IntegerField(choices=[(0, 'IDevID'), (1, 'TLS'), (2, 'Generic'), (3, 'Device Owner ID'), (4, 'Issuing CA Chain'), (5, 'OPC UA GDS Push')], verbose_name='Intended Usage'),
        ),
        migrations.CreateModel(
            name='CaModel',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('unique_name', models.CharField(help_text='Unique identifier for this CA', max_length=100, unique=True, validators=[util.field.UniqueNameValidator()], verbose_name='CA Name')),
                ('is_active', models.BooleanField(default=True, help_text='Whether this CA is currently active', verbose_name='Active')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Created')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Updated')),
                ('ca_type', models.IntegerField(blank=True, choices=[(-1, 'Keyless CA'), (0, 'Auto-Generated Root'), (1, 'Auto-Generated'), (2, 'Local-Unprotected'), (3, 'Local-PKCS11'), (4, 'Remote-EST-RA'), (5, 'Remote-CMP-RA'), (6, 'Remote-Issuing-EST'), (7, 'Remote-Issuing-CMP')], help_text='Type of CA - KEYLESS for keyless CAs', null=True, verbose_name='CA Type')),
                ('remote_host', models.CharField(blank=True, default='', help_text='The hostname or IP address of the remote PKI', max_length=253, verbose_name='Remote Host')),
                ('remote_port', models.PositiveIntegerField(blank=True, help_text='The port number of the remote PKI', null=True, verbose_name='Remote Port')),
                ('remote_path', models.CharField(blank=True, default='', help_text='The path on the remote PKI', max_length=255, verbose_name='Remote Path')),
                ('est_username', models.CharField(blank=True, default='', help_text='Username for EST authentication', max_length=128, verbose_name='EST Username')),
                ('certificate', models.ForeignKey(blank=True, help_text='The CA certificate (for keyless CAs)', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='keyless_cas', to='pki.certificatemodel', verbose_name='CA Certificate')),
                ('chain_truststore', models.OneToOneField(blank=True, help_text='The truststore containing the full certificate chain for this CA.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='issuing_ca', to='pki.truststoremodel', verbose_name='Chain Truststore')),
                ('credential', models.OneToOneField(blank=True, help_text='The CA credential with private key (for issuing CAs)', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='issuing_ca', to='pki.credentialmodel', verbose_name='Credential')),
                ('no_onboarding_config', models.ForeignKey(blank=True, help_text='No-onboarding configuration for remote CA connection', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='remote_cas', to='onboarding.noonboardingconfigmodel', verbose_name='No Onboarding Config')),
                ('onboarding_config', models.ForeignKey(blank=True, help_text='Onboarding configuration for remote CA connection', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='remote_cas', to='onboarding.onboardingconfigmodel', verbose_name='Onboarding Config')),
                ('parent_ca', models.ForeignKey(blank=True, help_text='The parent CA in the hierarchy (issuer of this CA)', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='child_cas', to='pki.camodel', verbose_name='Parent CA')),
            ],
            options={
                'verbose_name': 'Certificate Authority',
                'verbose_name_plural': 'Certificate Authorities',
                'db_table': 'pki_genericcamodel',
                'ordering': ['unique_name'],
            },
            bases=(trustpoint.logger.LoggerMixin, models.Model),
        ),
        migrations.AlterField(
            model_name='domainmodel',
            name='issuing_ca',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='domains', to='pki.camodel', verbose_name='Issuing CA'),
        ),
        migrations.AlterField(
            model_name='revokedcertificatemodel',
            name='ca',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='revoked_certificates', to='pki.camodel', verbose_name='Issuing CA'),
        ),
        migrations.CreateModel(
            name='CrlModel',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('crl_pem', models.TextField(help_text='The Certificate Revocation List in PEM format', verbose_name='CRL in PEM format')),
                ('crl_number', models.PositiveBigIntegerField(blank=True, help_text='The CRL number from the CRL extension', null=True, verbose_name='CRL Number')),
                ('this_update', models.DateTimeField(help_text='The thisUpdate field from the CRL', verbose_name='This Update')),
                ('next_update', models.DateTimeField(blank=True, help_text='The nextUpdate field from the CRL', null=True, verbose_name='Next Update')),
                ('is_active', models.BooleanField(default=True, help_text='Whether this is the current active CRL for the CA', verbose_name='Active')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Created')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Updated')),
                ('ca', models.ForeignKey(blank=True, help_text='The CA that issued this CRL', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='crls', to='pki.camodel', verbose_name='Certificate Authority')),
            ],
            options={
                'verbose_name': 'Certificate Revocation List',
                'verbose_name_plural': 'Certificate Revocation Lists',
                'ordering': ['-this_update'],
            },
            bases=(trustpoint.logger.LoggerMixin, models.Model),
        ),
        migrations.AddConstraint(
            model_name='camodel',
            constraint=models.CheckConstraint(condition=models.Q(models.Q(('ca_type', -1), ('certificate__isnull', False), ('credential__isnull', True)), models.Q(('ca_type__in', [0, 1, 2, 3, 6, 7]), ('certificate__isnull', True), ('credential__isnull', False)), models.Q(('ca_type__in', [4, 5]), ('certificate__isnull', True), ('credential__isnull', True)), _connector='OR'), name='ca_mode_constraint', violation_error_message='Invalid CA configuration'),
        ),
    ]
